AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: SAM Template for Alessandrina serverless application.
Globals:
  Function:
    Timeout: 10
    MemorySize: 128
    Runtime: go1.x
    Tracing: Active
    Architectures: [x86_64]
    AutoPublishAlias: !Ref Environment

Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - prod
    Description: Environment of this stack of resources

Mappings:
  ResourcesNameMap:
    dev:
      BooksAPI: BooksAPI-dev
      BooksTable: BooksTable-dev
      CreateBookFunction: CreateBookFunction-dev
    prod:
      BooksAPI: BooksAPI-prod
      BooksTable: BooksTable-prod
      CreateBookFunction: CreateBookFunction-prod

Resources:
  BooksAPI:
    Type: AWS::Serverless::HttpApi

  BooksTable:
    Type: AWS::Serverless::SimpleTable
    Properties:
      TableName: !FindInMap [ResourcesNameMap, !Ref Environment, BooksTable]
      PrimaryKey:
        Name: id
        Type: String
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5

  CreateBookFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: makefile
    Properties:
      CodeUri: .
      Handler: create-book
      Description: Create a new book
      Environment:
        Variables:
          STORAGE_MEMORY: false
          TABLE_NAME: !Ref BooksTable
          AWS_ENDPOINT_DEBUG: ""
          AWS_CLIENT_DEBUG: false
      Policies:
        - DynamoDBWritePolicy:
            TableName: !Ref BooksTable
      Events:
        ApiEvent:
          Type: HttpApi
          Properties:
            ApiId: !Ref BooksAPI
            Path: /books
            Method: POST

Outputs:
  WebEndpoint:
    Description: "API Gateway endpoint URL for the Books API"
    Value: !Sub "https://${BooksAPI}.execute-api.${AWS::Region}.amazonaws.com/"

  CreateBookFunction:
    Description: "CreateBook Lambda Function ARN"
    Value: !GetAtt CreateBookFunction.Arn
